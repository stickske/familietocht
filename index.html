<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8">
  <title>Familie Fietstocht</title>
  <link rel="icon" href="favicon.ico" type="image/x-icon">
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      margin: 20px;
      background-color: black;
      color: white;
    }
    img { max-width: 100%; display: none; margin-top: 20px; }
    button { font-size: 1.2em; padding: 10px 20px; margin: 20px; }
  </style>
</head>
<body>
  <h1 id="info">Familie Fietstocht</h1>
  <img id="photo" src="" alt="POI Photo">
  <audio id="sound_start" src="start.mp3" preload="auto"></audio>
  <audio id="sound_notification" src="ding.mp3" preload="auto"></audio>
  <br>
  <button id="startBtn">Start Fietstocht</button>

  <script>



    let CACHE_DATA_FOR_OFFLINE = false; //For full reset in service-worker.js you need to increment CACHE_DATA_002 to fully reset the local data


    

    if(CACHE_DATA_FOR_OFFLINE === false)
    {
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(registrations => {
          for(let registration of registrations) {
            registration.unregister();
            console.log("ServiceWorker verwijderd");
          }
        });
      }
    }


    const info = document.getElementById("info");
    const photo = document.getElementById("photo");
    const sound_start = document.getElementById("sound_start");
    const sound_notification = document.getElementById("sound_notification");
    const startBtn = document.getElementById("startBtn");

    let inside = new Set();
    let pois = [];
    let wakeLock = null;

    // Afstand in meters
    function distance(lat1, lon1, lat2, lon2)
    {
      const R = 6371000;
      const dLat = (lat2-lat1) * Math.PI/180;
      const dLon = (lon2-lon1) * Math.PI/180;
      const a = Math.sin(dLat/2)**2 +
                Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
                Math.sin(dLon/2)**2;
      return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    
    //let last_pos = null;

    function checkPosition(pos)
    {
      //last_pos = pos;

      const { latitude, longitude, accuracy } = pos.coords;

      for (const poi of pois) {
        const d = distance(latitude, longitude, poi.lat, poi.lon);

        // Add some tolerance based on GPS accuracy
        const threshold = 10; //+ accuracy/3; // meters
        if (d <= threshold && !inside.has(poi.img))
        {
          inside.add(poi.img);

          //Show the current point
          showPOI(poi);
        }

        if (d > threshold && inside.has(poi.img)) {
          inside.delete(poi.img);
        }

        if(inside.size <=0)
          clean();
      }
    }

    function showPOI(poi)
    {
      //To show location specified in current location show property
      let poiByShow = pois.find(p => p.img === poi.show);

      //To show current location
      //poiByShow = poi;

      if(poiByShow)
      {
        console.log("Show point: " + poiByShow.img);
        info.innerHTML = poiByShow.descr;
        photo.src = "img/" + encodeURIComponent(poiByShow.img) + ".jpg";
        photo.style.display = "block";
        sound_notification.play().catch(e => console.log("Audio blocked:", e));
      }
    }

    function clean()
    {
      console.log("Cleaning");
      info.innerHTML = "Zoek verder";
      photo.style.display = "none";
    }

    //Only per user request
    function fullScreen()
    {
      if (document.documentElement.requestFullscreen) {
        document.documentElement.requestFullscreen();
      } else if (document.documentElement.webkitRequestFullscreen) { /* Safari */
        document.documentElement.webkitRequestFullscreen();
      } else if (document.documentElement.msRequestFullscreen) { /* IE/Edge */
        document.documentElement.msRequestFullscreen();
      }
    }



    async function startApp()
    {
      console.log("Start APP");

      startBtn.style.display = "none";

      fullScreen();

      // POI-data laden
      try {
        const res = await fetch("pois.json");
        pois = await res.json();
      } catch(err) {
        console.error("Fout bij laden POI-data:", err);
        return;
      }


      //console.log(pois);

      // Geo locatie starten
      // Only check Geo if changes are detected in position
      navigator.geolocation.watchPosition(checkPosition, console.error, {enableHighAccuracy:true});

      // Wake Lock aanvragen
      try {
        wakeLock = await navigator.wakeLock.request('screen');
        wakeLock.addEventListener('release', () => console.log('Wake Lock released'));
      } catch(err) {
        console.error('Wake Lock error:', err.name, err.message);
      }

      // Start audio
      sound_start.play().catch(e => console.log("Audio interactie START:", e));

      // Service Worker
      if(CACHE_DATA_FOR_OFFLINE === true)
      {
        if ("serviceWorker" in navigator) {
          navigator.serviceWorker.register("service-worker.js")
            .then(() => console.log("Service Worker geregistreerd"))
            .catch(err => console.error("Service Worker fout:", err));
        }
      }
    }

    startBtn.addEventListener("click", startApp);

  </script>
</body>
</html>
